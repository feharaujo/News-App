language: android
sudo: true
jdk: oraclejdk8

env:
  global:
    - ANDROID_API_LEVEL=27
    - TARGET_VERSION=27
    - ANDROID_EMULATOR_LEVEL=25
    - ANDROID_BUILD_TOOLS_VERSION=27.0.3
    - ADB_INSTALL_TIMEOUT=30
    - ANDROID_ABI=x86
    - ANDROID_TAG=google_apis
    - QEMU_AUDIO_DRV=none

git:
  quiet: true

android:
  components:
    - tools
    - platform-tools
    - tools
    - build-tools-$ANDROID_BUILD_TOOLS_VERSION
    - android-$ANDROID_API_LEVEL
    - android-$ANDROID_EMULATOR_LEVEL
    - extra-android-support
    - extra-google-m2repository
    - extra-android-m2repository
    - sys-img-$ANDROID_ABI-google_apis-$ANDROID_EMULATOR_LEVEL

licenses:
  - android-sdk-preview-license-.+
  - android-sdk-license-.+
  - google-gdk-license-.+
  - android-googletv-license-.+
  - mips-android-sysimage-license-.+

cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
    - "$HOME/.android/build-cache"
    - "$HOME/.m2"

before_install:
  - echo "**************** before_install **************** "
  - cat $HOME/.m2/settings.xml
  - export ANDROID_HOME=~/android-sdk-linux
  - wget -q "https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip" -O android-sdk-tools.zip
  - unzip -q android-sdk-tools.zip -d ${ANDROID_HOME}
  - rm android-sdk-tools.zip
  - PATH=${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools
  - mkdir -p ~/.android
  - touch ~/.android/repositories.cfg
  - ./sdkmanager-accept-licenses.sh
  - ./sdkmanager-update-accept-all-licenses.sh
  - sdkmanager --list --verbose
#  - echo "yes" | sdkmanager "platform-tools" "platforms;android-29"
  - sdkmanager "emulator" "tools" "platform-tools" > /dev/null
#  - sdkmanager --list | head -15
#  - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION" "platforms;android-$TARGET_VERSION" > /dev/null
  - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION" "platforms;android-$TARGET_VERSION" "extras;google;m2repository" "extras;android;m2repository"
  - yes | sdkmanager "system-images;android-$ANDROID_EMULATOR_LEVEL;$ANDROID_TAG;$ANDROID_ABI" > /dev/null
  - mkdir /home/travis/android-sdk-linux/licenses || true
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
  - echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > "${ANDROID_HOME}/licenses/android-sdk-license"
  - echo no | avdmanager create avd --force -n test -k "system-images;android-$ANDROID_EMULATOR_LEVEL;$ANDROID_TAG;$ANDROID_ABI"

script:
  - echo "**************** SCRIPT **************** "
  - echo "Starting script section"
  - yes | sdkmanager --update
  - ./sdkmanager-accept-licenses.sh
  - ./sdkmanager-update-accept-all-licenses.sh
  - yes | sdkmanager "platform-tools" "platforms;android-27"
#  - yes | sdkmanager "platform-tools" "platforms;android-28"
  - android list target
  - emulator -avd "android-27" -no-window &
  - mkdir -p build/reports
  #  - ./gradlew dependencyCheckAnalyze
  - ./gradlew assembleDebugAndroidTest -PdisablePreDex --continue --stacktrace
  - android-wait-for-emulator
  #  - adb shell input keyevent 82 &
  - ./gradlew connectedDebugAndroidTest -PdisablePreDex --continue --stacktrace

after_failure:
  - cat $TRAVIS_BUILD_DIR/app/build/reports/lint-results.xml