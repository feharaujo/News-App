language: android
sudo: true
jdk: oraclejdk8

env:
  global:
    - ANDROID_API_LEVEL=27
    - TARGET_VERSION=27
    - ANDROID_EMULATOR_LEVEL=25
    - ANDROID_BUILD_TOOLS_VERSION=27.0.3
    - ADB_INSTALL_TIMEOUT=30
    - ANDROID_ABI=x86
    - ANDROID_TAG=google_apis
    - QEMU_AUDIO_DRV=none

git:
  quiet: true

android:
  components:
    - tools
    - platform-tools
    - tools
    - build-tools-$ANDROID_BUILD_TOOLS_VERSION
    - android-$ANDROID_API_LEVEL
    - android-$ANDROID_EMULATOR_LEVEL
    - extra-android-support
    - extra-google-m2repository
    - extra-android-m2repository
    - sys-img-$ANDROID_ABI-google_apis-$ANDROID_EMULATOR_LEVEL

licenses:
  - android-sdk-preview-license-.+
  - android-sdk-license-.+
  - google-gdk-license-.+
  - android-googletv-license-.+
  - mips-android-sysimage-license-.+

cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
    - "$HOME/.android/build-cache"
    - "$HOME/.m2"

before_install:
  - echo "**************** before_install **************** "
  - echo -e '<?xml version="1.0" encoding="UTF-8"?>\n<settings xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.1.0 http://maven.apache.org/xsd/settings-1.1.0.xsd" xmlns="http://maven.apache.org/SETTINGS/1.1.0"\n    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n  <mirrors>\n    <mirror>\n      <id>mvnsearch-unavailable</id>\n      <name>mvnsearch-unavailable</name>\n      <mirrorOf>mvnsearch</mirrorOf>\n      <url>http://repo1.maven.org/maven2</url>\n    </mirror>\n  </mirrors>\n  <profiles>\n    <profile>\n      <id>no-mvnsearch</id>\n      <repositories>\n        <repository>\n          <id>mvnsearch</id>\n          <url>http://www.mvnsearch.org/maven2</url>\n          <releases>\n            <enabled>true</enabled>\n          </releases>\n          <snapshots>\n            <enabled>true</enabled>\n          </snapshots>\n        </repository>\n      </repositories>\n    </profile>\n  </profiles>\n  <activeProfiles>\n    <activeProfile>no-mvnsearch</activeProfile>\n  </activeProfiles>\n</settings>' > $HOME/.m2/settings.xml
  - cat $HOME/.m2/settings.xml
  - export ANDROID_HOME=~/android-sdk-linux
  - wget -q "https://dl.google.com/android/repository/sdk-tools-linux-4333796.zip" -O android-sdk-tools.zip
  - unzip -q android-sdk-tools.zip -d ${ANDROID_HOME}
  - rm android-sdk-tools.zip
  - PATH=${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/tools/bin:${ANDROID_HOME}/platform-tools
  - mkdir -p ~/.android
  - touch ~/.android/repositories.cfg
  - yes | sdkmanager --update
  - yes | sdkmanager --licenses
#  - echo "yes" | sdkmanager "platform-tools" "platforms;android-29"
  - sdkmanager "emulator" "tools" "platform-tools" > /dev/null
#  - sdkmanager --list | head -15
  - yes | sdkmanager "build-tools;$ANDROID_BUILD_TOOLS_VERSION" "platforms;android-$TARGET_VERSION" > /dev/null
  - yes | sdkmanager "system-images;android-$ANDROID_EMULATOR_LEVEL;$ANDROID_TAG;$ANDROID_ABI" > /dev/null
#  - sdkmanager --list | head -15
  - mkdir "$ANDROID_HOME/licenses" || true
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > "$ANDROID_HOME/licenses/android-sdk-license"
  - echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_HOME/licenses/android-sdk-preview-license"
  - echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > "${ANDROID_HOME}/licenses/android-sdk-license"
  - echo no | avdmanager create avd --force -n test -k "system-images;android-$ANDROID_EMULATOR_LEVEL;$ANDROID_TAG;$ANDROID_ABI"

script:
  - echo "**************** SCRIPT **************** "
  - echo "Starting script section"
  - yes | sdkmanager --update
  - yes | sdkmanager --licenses
  - yes | sdkmanager "platform-tools" "platforms;android-27"
#  - yes | sdkmanager "platform-tools" "platforms;android-28"
  - android list target
  - emulator -avd "android-27" -no-window &
  - mkdir -p build/reports
  #  - ./gradlew dependencyCheckAnalyze
  - ./gradlew assembleDebugAndroidTest -PdisablePreDex --continue --stacktrace
  - android-wait-for-emulator
  #  - adb shell input keyevent 82 &
  - ./gradlew connectedDebugAndroidTest -PdisablePreDex --continue --stacktrace

after_failure:
  - cat $TRAVIS_BUILD_DIR/app/build/reports/lint-results.xml